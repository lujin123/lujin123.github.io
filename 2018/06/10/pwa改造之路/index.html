<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="不生产代码，只做代码的搬运工~"><title>pwa改造之路 | 小小落木</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">pwa改造之路</h1><a id="logo" href="/.">小小落木</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about"><i class="fa fa-user"> 关于</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">pwa改造之路</h1><div class="post-meta">Jun 10, 2018<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><p>公司移动端的项目使用<code>pwa</code>进行了改造，从原来的服务端直接模板渲染换成了前后端分离的纯前端渲染模式，再加上<code>pwa</code>进行一些缓存的加持(目前主要使用了<code>pwa</code>的缓存，其他的一些推送通知之类的东西还没有添加，以后有时间还是需要继续的)，感觉效果还是挺好的，主要技术栈使用了<code>vue</code>的全家桶，也遇到了一些<code>vue</code>的坑…</p>
<h2 id="service-worker-js文件目录问题"><a href="#service-worker-js文件目录问题" class="headerlink" title="service-worker.js文件目录问题"></a><code>service-worker.js</code>文件目录问题</h2><p>我的项目是通过<code>vue-cli</code>的<code>pwa</code>模板创建的，这东西创建一个项目起来还是很简单，但是，这个项目的模板也是有坑的，最大的坑就是他的<code>service-worker.js</code>文件中的一段代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">window</span>.location.protocol === <span class="string">'https:'</span> || isLocalhost)) &#123;</span><br><span class="line">    navigator.serviceWorker.register(<span class="string">'service-worker.js'</span>)</span><br><span class="line">        .then(<span class="function"><span class="keyword">function</span> (<span class="params">registration</span>) </span>&#123;</span><br></pre></td></tr></table></figure>
<p>这个<code>service-worker.js</code>是一个相对路径，导致只有页面在根目录下的时候才能将项目添加到首屏幕，其他的路径下都加不成功，因为只有根目录下才能下载成功<code>service-worker.js</code>这个文件，这个文件在<code>build</code>之后就在项目的根目录下，所以需要稍作修改成绝对路径即可</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">window</span>.location.protocol === <span class="string">'https:'</span> || isLocalhost)) &#123;</span><br><span class="line">    navigator.serviceWorker.register(<span class="string">'/service-worker.js'</span>)</span><br><span class="line">        .then(<span class="function"><span class="keyword">function</span> (<span class="params">registration</span>) </span>&#123;</span><br></pre></td></tr></table></figure>
<h2 id="文件缓存问题"><a href="#文件缓存问题" class="headerlink" title="文件缓存问题"></a>文件缓存问题</h2><p><code>vue-cli</code>创建的项目使用了一个<code>sw-precache-webpack-plugin&quot;</code>插件来做<code>precache</code>，但是也就只能做<code>prechache</code>，我还想要要做一些<code>runtime cache</code>这个插件是做不到的，所以基本上这个插件是废了</p>
<p>换一个插件名字叫做<code>workbox</code>,这个东西是对<code>sw-precache</code>和<code>sw-toolbox</code>的封装，都是<code>google</code>的，所以质量还是可以的，省去了对底层的<code>sw</code>接口的调用，更加方便…</p>
<p>具体<code>workbox</code>用法，就去查文档，列一下基础的东西</p>
<p>关于<code>precache</code>配置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> WorkboxPlugin.InjectManifest(&#123;</span><br><span class="line">  swDest: <span class="string">"service-worker.js"</span>,</span><br><span class="line">  swSrc: path.resolve(__dirname, <span class="string">"sw-prod.js"</span>),</span><br><span class="line">  exclude: [<span class="regexp">/\.(?:png|jpg|jpeg|svg)$/</span>, /\.map$/, <span class="string">".DS_Store"</span>]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>其他配置就写在<code>sw-prod.js</code>文件中即可，也就是写一写缓存策略等，其他的都已经封装好了，使用非常简单</p>
<p>关于缓存的策略，直接参考<code>workbox</code>的<a href="https://developers.google.com/web/tools/workbox/" target="_blank" rel="noopener">文档</a>就可以，说的都很清楚的，</p>
<h3 id="缓存策略主要需要注意跨域请求的缓存"><a href="#缓存策略主要需要注意跨域请求的缓存" class="headerlink" title="缓存策略主要需要注意跨域请求的缓存"></a>缓存策略主要需要注意跨域请求的缓存</h3><p>对于跨域请求，默认是需要使用<code>networkFirst</code>策略的，这是为了避免错误导致缓存无法被更新。如果不想用，那需要在其他策略中指定请求状态码，这样避免缓存了失败的请求结果，否则不会给你缓存</p>
<p>还有对于跨域的地址的正则表达式需要从头开始，例如</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">workbox.routing.registerRoute(</span><br><span class="line">  <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">"^https://cdn/static/img/"</span>),</span><br><span class="line">  workbox.strategies.cacheFirst(&#123;</span><br><span class="line">    cacheName: <span class="string">"static-images"</span>,</span><br><span class="line">    plugins: [</span><br><span class="line">      <span class="keyword">new</span> workbox.cacheableResponse.Plugin(&#123;</span><br><span class="line">        statuses: [<span class="number">0</span>, <span class="number">200</span>]</span><br><span class="line">      &#125;),</span><br><span class="line">      <span class="keyword">new</span> workbox.expiration.Plugin(&#123;</span><br><span class="line">        maxEntries: <span class="number">20</span>,</span><br><span class="line">        maxAgeSeconds: <span class="number">7</span> * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span></span><br><span class="line">      &#125;)</span><br><span class="line">    ]</span><br><span class="line">  &#125;)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>表达式开头的 <code>^</code> 最好不要省略，否则可能导致无法缓存请求</p>
<p>最后说一下，最好给<code>cacheFirst</code>缓存策略设置缓存时间和缓存的大小，也就是缓存的数量，这样可以防止缓存无法过期和占用空间过多的问题。例如上面那个例子的展示</p>
<h2 id="manifest-的问题"><a href="#manifest-的问题" class="headerlink" title="manifest 的问题"></a>manifest 的问题</h2><p>默认生成的<code>manifest.json</code>文件很简单， 不可配置，还缺少一些图标等，为了解决这样问题， 也找了些<code>webpack</code>插件，但是都有点问题，有些就是配置不全，还不能自己加，所以就自己写了一个，这样就方便多了，自动裁剪不同尺寸的图标，非常方便。<a href="https://github.com/lujin123/html-webpack-manifest-plugin" target="_blank" rel="noopener">插件地址</a></p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>其实还有些问题没有写出来，以后再说吧，现在就是记录下…</p>
<p>不过<code>pwa</code>还是很好用的，用了之后用户体验好了很多，页面加载速度快了很多，尤其是一些图片缓存了也可以减少流量…当初做这个的时候还对标着<code>Flipkart</code>，他们的<code>pwa</code>做的真的很好了，用起来感觉很像原生的，流畅度很好，听说是他们派了人去<code>google</code>，然后<code>google</code>分了一二十人帮他们一起做的…</p>
<p><code>pwa</code>的不足主要在用户首次使用的时候没有缓存，需要的文件都要下载，第一次首屏的优化还是要做的，否则白屏时间会比较长。还有就是关于升级的问题，做好降级的开关，否则要是<code>sw</code>出问题了，那就更新不了了…</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2018/06/10/pwa改造之路/" data-id="cjse22bqf0001z2i6mn6u4izk" class="article-share-link">分享</a><div class="tags"></div><div class="post-nav"><a href="/2019/02/20/MySQL中的Int-N/" class="pre">MySQL中的Int-N</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://yoursite.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/MySQL/" style="font-size: 15px;">MySQL</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/02/20/MySQL中的Int-N/">MySQL中的Int-N</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/10/pwa改造之路/">pwa改造之路</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/lujin123" title="GitHub" target="_blank">GitHub</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">小小落木.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>